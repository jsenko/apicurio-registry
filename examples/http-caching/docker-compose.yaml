services:

  # Apicurio Registry (Backend)
  registry:
    container_name: registry-backend
    image: ${REGISTRY_IMAGE:-quay.io/apicurio/apicurio-registry:latest-snapshot}
    environment:
      QUARKUS_PROFILE: "prod"
      # Caching
      APICURIO_HTTP_CACHING_ENABLED: "true"
      APICURIO_HTTP_CACHING_OPAQUE_ETAGS_ENABLED: "false" # Needed for testing.
      # Enable Registry features that affect caching:
      APICURIO_AUTH_ANONYMOUS_READ_ACCESS_ENABLED: "true"
      APICURIO_REST_MUTABILITY_ARTIFACT_VERSION_CONTENT_ENABLED: "true"
      # Logging
      LOG_LEVEL: "INFO"
      QUARKUS_LOG_CATEGORY__IO_APICURIO__LEVEL: "DEBUG"
      # CORS
      QUARKUS_HTTP_CORS: "true"
      QUARKUS_HTTP_CORS_ORIGINS: "*"
    ports:
      - "8080:8080"  # Direct access to registry (bypass cache)
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8080/health/live" ]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 30s

  # Varnish Cache (HTTP Proxy Cache)
  varnish:
    container_name: varnish-cache
    image: varnish:7.4
    volumes:
      - ./varnish/default.vcl:/etc/varnish/default.vcl:ro
    ports:
      - "8081:8081"    # Cached access to registry
      - "6080:6080"  # Varnish admin interface
    environment:
      VARNISH_SIZE: 256M
    entrypoint: [ ]
    command:
      - "sh"
      - "-c"
      - |
        echo "dev-secret" > /tmp/varnish-secret &&
        /usr/sbin/varnishd -F \
          -f /etc/varnish/default.vcl \
          -a http=:8081,HTTP \
          -T :6080 \
          -S /tmp/varnish-secret \
          -s malloc,256M \
          -p default_ttl=3600 \
          -p default_grace=3600 &
        sleep 2 &&
        varnishlog -g request -i ReqMethod,ReqURL,ReqHeader,BerespStatus,BerespHeader,ObjStatus,RespHeader -q 'ReqURL ~ "^/apis/registry"'
    depends_on:
      registry:
        condition: service_healthy
    healthcheck:
      test: [ "CMD", "sh", "-c", "varnishadm -T :6080 -S /tmp/varnish-secret ping" ]
      interval: 5s
      timeout: 2s
      retries: 3
      start_period: 10s

  # Apicurio Registry UI
  ui:
    container_name: registry-ui
    image: ${UI_IMAGE:-quay.io/apicurio/apicurio-registry-ui:latest-snapshot}
    environment:
      # Connect to Varnish (cached endpoint) for better performance
      REGISTRY_API_URL: http://localhost:8081/apis/registry/v3
    ports:
      - "8888:8080"  # UI web interface
    depends_on:
      varnish:
        condition: service_healthy

networks:
  default:
    name: registry-cache-network
